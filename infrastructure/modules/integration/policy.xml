<policies>
  <inbound>
    <base />
    <cors allow-credentials="true">
      <allowed-origins>
        <origin>@(context.Request.Headers.GetValueOrDefault("Origin", "*"))</origin>
      </allowed-origins>
      <allowed-methods>
        <method>GET</method>
        <method>POST</method>
        <method>OPTIONS</method>
      </allowed-methods>
      <allowed-headers>
        <header>*</header>
      </allowed-headers>
    </cors>

    <validate-jwt header-name="Authorization"
                  failed-validation-httpcode="401"
                  failed-validation-error-message="Unauthorized APIM"
                  require-expiration-time="true"
                  require-scheme="Bearer">
      <openid-config url="https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration" />

      <required-claims>
        <claim name="aud" match="any">
          <value>__EXPECTED_AUDIENCE__</value>
          <value>__EXPECTED_AUDIENCE_CLIENT_ID__</value>
        </claim>

        <claim name="scp" match="any" separator=" ">
          <value>__REQUIRED_SCOPE__</value>
        </claim>
      </required-claims>
    </validate-jwt>

    <set-header name="x-user-id" exists-action="override">
      <value>@(context.Request.Headers.GetValueOrDefault("Authorization","").AsJwt().Claims.GetValueOrDefault("oid", context.Request.Headers.GetValueOrDefault("Authorization","").AsJwt().Subject))</value>
    </set-header>

    <set-variable name="request-body" value="@(context.Request.Body.As&lt;string&gt;(true))" />

    <set-variable name="target-fn" value='@{
        var body = (string)context.Variables.GetValueOrDefault("request-body", "");
        if (!string.IsNullOrEmpty(body) &amp;&amp; body.Contains("registerDevice")) {
            return "true";
        }
        return "false";
    }' />

    <set-variable name="is-signalr" value="@(context.Request.OriginalUrl.Path.Contains("/signalr") &amp;&amp; context.Request.Method == "GET")" />



    <choose>
      <when condition='@(context.Variables.GetValueOrDefault("target-fn", "") == "true")'>
        <send-one-way-request mode="new">
          <set-url>{{function-app-url}}/api/register_device</set-url>
          <set-method>POST</set-method>
          <set-header name="x-functions-key" exists-action="override">
            <value>{{function-key}}</value>
          </set-header>
          <set-header name="x-user-id" exists-action="override">
            <value>@(context.Request.Headers.GetValueOrDefault("x-user-id", ""))</value>
          </set-header>
          <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
          </set-header>
          <set-body>@((string)context.Variables.GetValueOrDefault("request-body", ""))</set-body>
        </send-one-way-request>

        <return-response>
          <set-status code="200" reason="OK" />
          <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
          </set-header>
          <set-body>{ "data": { "registerDevice": true, "__typename": "Mutation" } }</set-body>
        </return-response>
      </when>
      <when condition='@(context.Variables.GetValueOrDefault("is-signalr", false))'>
        <set-backend-service base-url="{{function-app-url}}" />
        <rewrite-uri template="/api/signalr" />
        <set-header name="x-functions-key" exists-action="override">
          <value>{{function-key}}</value>
        </set-header>
        <set-header name="x-user-id" exists-action="override">
          <value>@(context.Request.Headers.GetValueOrDefault("x-user-id", ""))</value>
        </set-header>
      </when>
    </choose>

    <set-header name="Authorization" exists-action="override">
      <value>@(context.Request.Headers.GetValueOrDefault("Authorization", ""))</value>
    </set-header>

    <set-header name="X-Forwarded-For" exists-action="override">
      <value>@(context.Request.IpAddress)</value>
    </set-header>
    <set-header name="X-Forwarded-Proto" exists-action="override">
      <value>https</value>
    </set-header>
  </inbound>

  <backend>
    <retry condition="@(context.LastError != null || (context.Response != null &amp;&amp; (context.Response.StatusCode == 502 || context.Response.StatusCode == 503 || context.Response.StatusCode == 504)))" count="6" interval="10" first-fast-retry="false">
      <forward-request timeout="120" />
    </retry>
  </backend>

  <outbound>
    <base />
  </outbound>

  <on-error>
    <base />
    <choose>
      <when condition="@(context.Response.StatusCode >= 400)">
        <return-response>
          <set-status code="@(context.Response.StatusCode)" reason="@(context.Response.StatusReason)" />
          <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
          </set-header>
          <set-body>@{
            var status = context.Response.StatusCode;
            var reason = context.Response.StatusReason;
            return "{ \"errors\": [ { \"message\": \"APIM Error: " + status + " " + reason + "\", \"extensions\": { \"code\": \"APIM_ERROR\", \"statusCode\": " + status + " } } ] }";
          }</set-body>
        </return-response>
      </when>
    </choose>
  </on-error>
</policies>
