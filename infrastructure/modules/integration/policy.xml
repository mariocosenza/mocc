<policies>
  <inbound>
    <base />

    <validate-jwt header-name="Authorization"
                  failed-validation-httpcode="401"
                  failed-validation-error-message="Unauthorized"
                  require-expiration-time="true"
                  require-scheme="Bearer">
      <openid-config url="https://login.microsoftonline.com/__TENANT_ID__/v2.0/.well-known/openid-configuration" />

      <required-claims>
        <!-- Audience: must match your API App Registration "Application ID URI" or expected audience -->
        <claim name="aud">
          <value>__EXPECTED_AUDIENCE__</value>
        </claim>

        <!-- Issuer: for v2 tokens, issuer includes /v2.0 -->
        <claim name="iss">
          <value>https://login.microsoftonline.com/__TENANT_ID__/v2.0</value>
        </claim>

        <!-- Scope: for delegated permissions, scp is space-separated -->
        <claim name="scp" match="any" separator=" ">
          <value>__REQUIRED_SCOPE__</value>
        </claim>
      </required-claims>
    </validate-jwt>

    <validate-graphql-request error-variable-name="graphql-validation-error" />
    <choose>
      <when condition='@(!string.IsNullOrEmpty((string)context.Variables.GetValueOrDefault("graphql-validation-error", "")))'>
        <return-response>
          <set-status code="400" reason="Bad Request" />
          <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
          </set-header>
          <set-body>@{
            var err = (string)context.Variables.GetValueOrDefault("graphql-validation-error", "");
            err = err.Replace("\\", "\\\\").Replace("\"", "\\\"").Replace("\r", "\\r").Replace("\n", "\\n");
            return "{ \"error\": \"Invalid GraphQL request\", \"details\": \"" + err + "\" }";
          }</set-body>
        </return-response>
      </when>
    </choose>

    <!-- Backend URL resolved at runtime from APIM Named Value -->
    <set-backend-service base-url="{{backend-base-url}}" />

    <set-header name="X-Forwarded-For" exists-action="override">
      <value>@(context.Request.IpAddress)</value>
    </set-header>
    <set-header name="X-Forwarded-Proto" exists-action="override">
      <value>https</value>
    </set-header>
  </inbound>

  <backend>
    <base />
  </backend>

  <outbound>
    <base />
  </outbound>

  <on-error>
    <base />
  </on-error>
</policies>
