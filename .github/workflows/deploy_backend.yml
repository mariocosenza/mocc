name: Backend (Go) - Build, Push to ACR, and Roll Revision on ACA

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  ACR_NAME: moccdockeregistry
  ACR_LOGIN_SERVER: moccdockeregistry.azurecr.io
  IMAGE_NAME: mocc-backend
  DOCKERFILE_PATH: ./backend/Dockerfile
  CONTEXT: ./backend

  # ACA target
  RESOURCE_GROUP: moccgroup
  CONTAINERAPP_NAME: mocc-aca

jobs:
  build_push_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute image tag (commit SHA)
        id: vars
        run: |
          echo "SHA_TAG=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name $ACR_NAME

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image (latest + SHA)
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.CONTEXT }}
          file: ${{ env.DOCKERFILE_PATH }}
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.SHA_TAG }}

      - name: Install/Update Azure Container Apps extension
        run: |
          az extension add --name containerapp --upgrade

      - name: Configure ACA Registry Authentication
        run: |
          az containerapp registry set \
            --name "${CONTAINERAPP_NAME}" \
            --resource-group "${RESOURCE_GROUP}" \
            --server "${ACR_LOGIN_SERVER}" \
            --identity system

      - name: Roll ACA revision with environment variables
        run: |
          IMAGE="${ACR_LOGIN_SERVER}/${IMAGE_NAME}:${{ steps.vars.outputs.SHA_TAG }}"
          az containerapp update \
            --name "${CONTAINERAPP_NAME}" \
            --resource-group "${RESOURCE_GROUP}" \
            --image "${IMAGE}" \
            --set-env-vars \
              "PORT=8080" \
              "RUNNING_ON_AZURE=true" \
              "REDIS_URL=${{ secrets.REDIS_URL }}" \
              "COSMOS_URL=${{ secrets.COSMOS_URL }}" \
              "AZURE_STORAGE_ACCOUNT_NAME=${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
              "AZURE_STORAGE_CONTAINER_SOCIAL=social" \
              "AUTH_AUTHORITY=${{ secrets.AUTH_AUTHORITY }}" \
              "EXPECTED_AUDIENCE=${{ secrets.EXPECTED_AUDIENCE }}" \
              "REQUIRED_SCOPE=access_as_user" \
              "MANAGED_IDENTITY_CLIENT_ID=${{ secrets.MANAGED_IDENTITY_CLIENT_ID }}"
